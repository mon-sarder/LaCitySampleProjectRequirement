<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create account â€¢ Robot Driver</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <main class="container">
    <section class="card auth-card stack" aria-labelledby="regH">
      <h1 id="regH" style="margin:0">Create account</h1>

      {# Flash messages #}
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="stack" role="status" aria-live="polite">
            {% for category, message in messages %}
              <div class="badge {% if category == 'success' %}success{% elif category == 'error' %}error{% elif category == 'warn' %}warn{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form id="regForm" method="post" class="stack" autocomplete="off" novalidate>
        <div class="stack">
          <label for="username">Username</label>
          <input
            id="username"
            name="username"
            type="text"
            maxlength="50"
            required
            autocomplete="username"
            placeholder="Choose a username"
          />
          <small class="char-limit">Max 50 characters</small>
        </div>

        <div class="stack">
          <label for="password">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            maxlength="50"
            required
            autocomplete="new-password"
            placeholder="Create a password"
          />
          <small class="char-limit">Max 50 characters</small>
        </div>

        <div class="stack">
          <label for="confirm">Confirm password</label>
          <input
            id="confirm"
            name="confirm"
            type="password"
            maxlength="50"
            required
            autocomplete="new-password"
            placeholder="Re-enter your password"
          />
          <small id="matchHint" class="hint muted">Both passwords must match.</small>
          <label class="inline" style="margin-top:6px">
            <input id="togglePwd" type="checkbox" />
            <span class="muted">Show passwords</span>
          </label>
        </div>

        <div class="auth-actions">
          <button id="submitBtn" type="submit" class="primary">Create account</button>
          <a class="button ghost" href="{{ url_for('login') }}">Back to sign in</a>
        </div>
      </form>
    </section>
  </main>

  <script>
    // Show/hide both password fields
    const togglePwd = document.getElementById('togglePwd');
    const pwd = document.getElementById('password');
    const conf = document.getElementById('confirm');
    togglePwd.addEventListener('change', () => {
      const type = togglePwd.checked ? 'text' : 'password';
      pwd.type = type;
      conf.type = type;
    });

    // Client-side match check (helpful, server still enforces)
    const matchHint = document.getElementById('matchHint');
    const submitBtn = document.getElementById('submitBtn');
    function checkMatch() {
      const p = pwd.value || '';
      const c = conf.value || '';
      const tooLong = p.length > 50 || c.length > 50;
      const mismatch = p && c && p !== c;
      let msg = 'Both passwords must match.';
      let ok = true;

      if (tooLong) {
        msg = 'Password fields must be 50 characters or fewer.';
        ok = false;
      } else if (mismatch) {
        msg = 'Passwords do not match.';
        ok = false;
      }
      matchHint.textContent = msg;
      matchHint.classList.toggle('err', !ok);
      matchHint.classList.toggle('muted', ok);
      submitBtn.disabled = !ok;
    }
    pwd.addEventListener('input', checkMatch);
    conf.addEventListener('input', checkMatch);

    // Hard-stop if someone exceeds maxlength (belt-and-suspenders)
    document.getElementById('regForm').addEventListener('submit', (e) => {
      const u = document.getElementById('username').value || '';
      const p = pwd.value || '';
      const c = conf.value || '';
      if (u.length > 50 || p.length > 50 || c.length > 50) {
        e.preventDefault();
        alert('Username and passwords must be 50 characters or fewer.');
        return;
      }
      if (p !== c) {
        e.preventDefault();
        alert('Passwords do not match.');
      }
    });

    // Initialize button state on load
    checkMatch();
  </script>
</body>
</html>
